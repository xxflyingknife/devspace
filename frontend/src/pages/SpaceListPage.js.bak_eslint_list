import React, { useState, useEffect } from 'react';
import Header from '../components/Header';
import SpaceCard from '../components/SpaceCard';
import SpaceListItem from '../components/SpaceListItem'; // For list view
import Modal from '../components/Modal';
import Drawer from '../components/Drawer';
import './SpaceListPage.css';

// Mock backend functions (replace with actual API calls)
const mockFetchSpaces = async () => {
  await new Promise(resolve => setTimeout(resolve, 300)); // Simulate delay
  return [
    { id: 'proj-prefab-modular', name: 'é¢„åˆ¶å’Œæ¨¡å—åŒ–å»ºç­‘å¸‚åœºæ¦‚è§ˆ', type: 'dev', date: '2025å¹´5æœˆ5æ—¥', sourceCount: 16, icon: 'ğŸ“¦', color: '#E0F2F7' },
    { id: 'ops-cluster-monitor', name: 'ç”Ÿäº§ç¯å¢ƒé›†ç¾¤ç›‘æ§ Ops', type: 'ops', date: '2025å¹´5æœˆ6æ—¥', sourceCount: 22, icon: 'ğŸ› ï¸', color: '#E8F5E9' },
    { id: 'art-wheelwrighting', name: 'The Art and Craft of Wheelwrighting', type: 'dev', date: '2025å¹´5æœˆ5æ—¥', sourceCount: 9, icon: 'âš™ï¸', color: '#FFF9C4' },
    { id: 'play-benefits', name: 'æˆ·ç©æ¸¸æˆå¯¹å„¿ç«¥æˆé•¿çš„ç›Šå¤„', type: 'dev', date: '2025å¹´5æœˆ11æ—¥', sourceCount: 15, icon: 'ğŸ¡', color: '#E8F5E9' },
    { id: 'sre-incident-response', name: 'SRE äº‹ä»¶å“åº”æ‰‹å†Œ Ops', type: 'ops', date: '2025å¹´5æœˆ12æ—¥', sourceCount: 18, icon: 'ğŸš¨', color: '#FFEBEE' },
    { id: 'disaster-checklist', name: 'ç¾å®³åº”æ€¥ç‰©å“æ¸…å•', type: 'dev', date: '2025å¹´5æœˆ11æ—¥', sourceCount: 12, icon: 'â±ï¸', color: '#FCE4EC' },
  ];
};
const mockCreateSpace = async (spaceData) => {
    console.log("Creating space:", spaceData);
    await new Promise(resolve => setTimeout(resolve, 500));
    return { ...spaceData, id: `new-${Math.random().toString(16).slice(2)}`, date: new Date().toLocaleDateString('zh-CN'), sourceCount: 0 }; // Return new space with ID
};
const mockUpdateSpaceTitle = async (spaceId, newTitle) => {
    console.log("Updating title for:", spaceId, "to:", newTitle);
    await new Promise(resolve => setTimeout(resolve, 300));
    return true;
};
const mockDeleteSpace = async (spaceId) => {
    console.log("Deleting space:", spaceId);
    await new Promise(resolve => setTimeout(resolve, 300));
    return true;
};


function SpaceListPage() {
  const [spaces, setSpaces] = useState([]);
  const [filteredSpaces, setFilteredSpaces] = useState([]);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  const [viewMode, setViewMode] = useState('grid'); // 'grid' or 'list'
  const [filterType, setFilterType] = useState('all'); // 'all', 'dev', 'ops'
  const [searchTerm, setSearchTerm] = useState(''); // For potential future search

  const [showNewSpaceModal, setShowNewSpaceModal] = useState(false);
  const [showEditSpaceModal, setShowEditSpaceModal] = useState(false);
  const [editingSpace, setEditingSpace] = useState(null); // {id, name}

  const [newSpaceName, setNewSpaceName] = useState('');
  const [newSpaceType, setNewSpaceType] = useState('dev');
  const [newSpaceDescription, setNewSpaceDescription] = useState('');

  const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'system');
  const [showHelpDrawer, setShowHelpDrawer] = useState(false);
  const [showFeedbackDrawer, setShowFeedbackDrawer] = useState(false);

  // Fetch initial spaces
  useEffect(() => {
    setIsLoading(true);
    mockFetchSpaces()
      .then(data => {
        setSpaces(data);
        setFilteredSpaces(data); // Initially show all
      })
      .catch(err => {
        console.error("Error fetching spaces:", err);
        setError("æ— æ³•åŠ è½½ç©ºé—´åˆ—è¡¨");
      })
      .finally(() => setIsLoading(false));
  }, []);

  // Apply filtering when filterType or spaces change
  useEffect(() => {
    let currentSpaces = [...spaces];
    if (filterType !== 'all') {
      currentSpaces = currentSpaces.filter(space => space.type === filterType);
    }
    // TODO: Add search term filtering if implemented
    // if (searchTerm) {
    //   currentSpaces = currentSpaces.filter(space => space.name.toLowerCase().includes(searchTerm.toLowerCase()));
    // }
    setFilteredSpaces(currentSpaces);
  }, [spaces, filterType, searchTerm]);

  // Apply theme to body
  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
  }, [theme]);

  const handleToggleTheme = (selectedTheme) => {
    setTheme(selectedTheme);
  };

  const handleCreateNewSpace = async (e) => {
    e.preventDefault();
    if (!newSpaceName.trim()) {
      alert("ç©ºé—´åç§°ä¸èƒ½ä¸ºç©º");
      return;
    }
    const spaceData = { name: newSpaceName, type: newSpaceType, description: newSpaceDescription };
    try {
      const newSpace = await mockCreateSpace(spaceData);
      setSpaces(prev => [newSpace, ...prev]); // Add to start of list
      setShowNewSpaceModal(false);
      setNewSpaceName(''); setNewSpaceType('dev'); setNewSpaceDescription(''); // Reset form
    } catch (err) {
      alert("åˆ›å»ºç©ºé—´å¤±è´¥: " + err.message);
    }
  };

  const handleDeleteSpace = async (spaceId, spaceName) => {
    if (window.confirm(`ç¡®å®šè¦åˆ é™¤ç©ºé—´ "${spaceName}" å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚`)) {
      try {
        await mockDeleteSpace(spaceId);
        setSpaces(prev => prev.filter(s => s.id !== spaceId));
      } catch (err) {
        alert("åˆ é™¤ç©ºé—´å¤±è´¥: " + err.message);
      }
    }
  };

  const openEditModal = (spaceId, currentName) => {
    setEditingSpace({ id: spaceId, name: currentName });
    setNewSpaceName(currentName); // Pre-fill for editing
    setShowEditSpaceModal(true);
  };

  const handleEditSpaceTitle = async (e) => {
    e.preventDefault();
    if (!editingSpace || !newSpaceName.trim()) return;
    try {
      await mockUpdateSpaceTitle(editingSpace.id, newSpaceName);
      setSpaces(prev => prev.map(s => s.id === editingSpace.id ? { ...s, name: newSpaceName } : s));
      setShowEditSpaceModal(false);
      setEditingSpace(null);
      setNewSpaceName(''); // Reset
    } catch (err) {
      alert("ä¿®æ”¹æ ‡é¢˜å¤±è´¥: " + err.message);
    }
  };


  if (isLoading) return <div className="loading-fullpage">åŠ è½½ä¸­...</div>;
  if (error) return <div className="error-fullpage">{error}</div>;

  return (
    <div className="space-list-page-container">
      <Header
        pageType="list"
        onToggleTheme={handleToggleTheme}
        onShowHelp={() => setShowHelpDrawer(true)}
        onShowFeedback={() => setShowFeedbackDrawer(true)}
      />
      <main className="space-list-main">
        <div className="space-list-header">
          {/* Title removed as per new design for list page header */}
          <div className="space-list-controls">
             <button className="new-space-button" onClick={() => setShowNewSpaceModal(true)}>+ æ–°å»º</button>
             <div className="view-controls">
                 <button
                    className={`control-button ${viewMode === 'grid' ? 'active' : ''}`}
                    onClick={() => setViewMode('grid')}
                    aria-label="Grid view"
                 >
                    [â–¦] {/* Grid Icon */}
                 </button>
                 <button
                    className={`control-button ${viewMode === 'list' ? 'active' : ''}`}
                    onClick={() => setViewMode('list')}
                    aria-label="List view"
                 >
                    [â‰¡] {/* List Icon */}
                 </button>
             </div>
             <select
                className="filter-dropdown"
                value={filterType}
                onChange={(e) => setFilterType(e.target.value)}
                aria-label="Filter spaces by type"
              >
                 <option value="all">æ‰€æœ‰ç©ºé—´</option>
                 <option value="dev">Dev ç©ºé—´</option>
                 <option value="ops">Ops ç©ºé—´</option>
             </select>
          </div>
        </div>

        {viewMode === 'grid' ? (
          <div className="space-grid">
            {filteredSpaces.map(space => (
              <SpaceCard
                key={space.id}
                {...space}
                onDelete={handleDeleteSpace}
                onEditTitle={openEditModal}
              />
            ))}
          </div>
        ) : (
          <ul className="space-list-view">
            {/* Optional: Add list headers */}
            {/* <li className="space-list-header-row">
                <div>Icon</div><div>Name</div><div>Type</div><div>Sources</div><div>Date</div><div>Actions</div>
            </li> */}
            {filteredSpaces.map(space => (
              <SpaceListItem
                key={space.id}
                {...space}
                onDelete={handleDeleteSpace}
                onEditTitle={openEditModal}
              />
            ))}
          </ul>
        )}
        {filteredSpaces.length === 0 && !isLoading && (
            <p className="no-spaces-message">æ²¡æœ‰æ‰¾åˆ°ç¬¦åˆæ¡ä»¶çš„ç©ºé—´ã€‚</p>
        )}
      </main>

      {/* New Space Modal */}
      <Modal
        isOpen={showNewSpaceModal}
        onClose={() => setShowNewSpaceModal(false)}
        title="æ–°å»ºç©ºé—´"
        footerContent={
          <>
            <button type="button" className="modal-button secondary" onClick={() => setShowNewSpaceModal(false)}>å–æ¶ˆ</button>
            <button type="submit" form="new-space-form" className="modal-button primary">åˆ›å»º</button>
          </>
        }
      >
        <form id="new-space-form" className="modal-form" onSubmit={handleCreateNewSpace}>
          <div className="form-group">
            <label htmlFor="newSpaceName">ç©ºé—´åç§°</label>
            <input
              type="text"
              id="newSpaceName"
              value={newSpaceName}
              onChange={(e) => setNewSpaceName(e.target.value)}
              required
              placeholder="ä¾‹å¦‚ï¼šæˆ‘çš„é¡¹ç›® A"
            />
          </div>
          <div className="form-group">
            <label htmlFor="newSpaceType">ç©ºé—´ç±»å‹</label>
            <select id="newSpaceType" value={newSpaceType} onChange={(e) => setNewSpaceType(e.target.value)}>
              <option value="dev">Dev (å¼€å‘)</option>
              <option value="ops">Ops (è¿ç»´)</option>
            </select>
          </div>
          <div className="form-group">
            <label htmlFor="newSpaceDescription">ç©ºé—´è¯´æ˜ (å¯é€‰)</label>
            <textarea
              id="newSpaceDescription"
              value={newSpaceDescription}
              onChange={(e) => setNewSpaceDescription(e.target.value)}
              rows="3"
              placeholder="ç®€è¦æè¿°è¿™ä¸ªç©ºé—´çš„ç”¨é€”..."
            />
          </div>
        </form>
      </Modal>

      {/* Edit Space Title Modal */}
      {editingSpace && (
        <Modal
            isOpen={showEditSpaceModal}
            onClose={() => { setShowEditSpaceModal(false); setEditingSpace(null); setNewSpaceName('');}}
            title="ä¿®æ”¹ç©ºé—´æ ‡é¢˜"
            footerContent={
              <>
                <button type="button" className="modal-button secondary" onClick={() => { setShowEditSpaceModal(false); setEditingSpace(null); setNewSpaceName('');}}>å–æ¶ˆ</button>
                <button type="submit" form="edit-space-form" className="modal-button primary">ä¿å­˜</button>
              </>
            }
        >
            <form id="edit-space-form" className="modal-form" onSubmit={handleEditSpaceTitle}>
                <div className="form-group">
                    <label htmlFor="editSpaceName">æ–°ç©ºé—´åç§°</label>
                    <input
                        type="text"
                        id="editSpaceName"
                        value={newSpaceName} // Use newSpaceName for controlled input
                        onChange={(e) => setNewSpaceName(e.target.value)}
                        required
                    />
                </div>
            </form>
        </Modal>
      )}

      {/* Help Drawer */}
      <Drawer isOpen={showHelpDrawer} onClose={() => setShowHelpDrawer(false)} title="å¸®åŠ©ä¸­å¿ƒ" position="right">
        <div className="drawer-content-placeholder">
            <h2>å¦‚ä½•ä½¿ç”¨æœ¬å¹³å°</h2>
            <p>è¿™æ˜¯ä¸€ä¸ª DevOps åŠ©æ‰‹å¹³å°ï¼Œæ—¨åœ¨å¸®åŠ©æ‚¨...</p>
            <p><strong>ç©ºé—´åˆ—è¡¨:</strong> æ‚¨å¯ä»¥åˆ›å»ºä¸åŒç±»å‹çš„ç©ºé—´æ¥ç»„ç»‡æ‚¨çš„é¡¹ç›®ã€‚</p>
            <p><strong>Dev ç©ºé—´:</strong> ä¸“æ³¨äºä»£ç ç®¡ç†å’ŒæŒç»­é›†æˆ/éƒ¨ç½²...</p>
            <p><strong>Ops ç©ºé—´:</strong> ä¸“æ³¨äºç›‘æ§ã€AIOps å’Œè‡ªåŠ¨åŒ–è¿ç»´ä»»åŠ¡...</p>
            <p><strong>èŠå¤©äº¤äº’:</strong> åœ¨æ¯ä¸ªç©ºé—´è¯¦æƒ…é¡µï¼Œæ‚¨å¯ä»¥é€šè¿‡èŠå¤©ä¸ AI åŠ©æ‰‹äº¤äº’ï¼Œæ‰§è¡Œç›¸å…³æ“ä½œã€‚</p>
            <h3>å¸¸è§é—®é¢˜</h3>
            <ul>
                <li>å¦‚ä½•è¿æ¥æˆ‘çš„ Git ä»“åº“ï¼Ÿ (åœ¨ Dev ç©ºé—´è¯¦æƒ…é¡µå·¦ä¾§æ é…ç½®)</li>
                <li>å¦‚ä½•é…ç½® K8s éƒ¨ç½²ç¯å¢ƒï¼Ÿ (åœ¨ Dev ç©ºé—´è¯¦æƒ…é¡µå³ä¾§æ é…ç½®)</li>
                <li>å¦‚ä½•ä½¿ç”¨ AIOps æŠ€èƒ½ï¼Ÿ (åœ¨ Ops ç©ºé—´è¯¦æƒ…é¡µå³ä¾§æ é€‰æ‹©)</li>
            </ul>
            {/* Add more detailed help content */}
        </div>
      </Drawer>

      {/* Feedback Drawer */}
      <Drawer isOpen={showFeedbackDrawer} onClose={() => setShowFeedbackDrawer(false)} title="æäº¤åé¦ˆ" position="right">
        <div className="drawer-content-placeholder">
            <h2>æˆ‘ä»¬é‡è§†æ‚¨çš„æ„è§ï¼</h2>
            <p>å¦‚æœæ‚¨åœ¨ä½¿ç”¨è¿‡ç¨‹ä¸­é‡åˆ°ä»»ä½•é—®é¢˜ï¼Œæˆ–æœ‰ä»»ä½•æ”¹è¿›å»ºè®®ï¼Œè¯·å‘Šè¯‰æˆ‘ä»¬ã€‚</p>
            <form className="feedback-form" onSubmit={(e) => {e.preventDefault(); alert('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼'); setShowFeedbackDrawer(false);}}>
                <div className="form-group">
                    <label htmlFor="feedbackType">åé¦ˆç±»å‹</label>
                    <select id="feedbackType">
                        <option value="bug">é”™è¯¯æŠ¥å‘Š</option>
                        <option value="feature">åŠŸèƒ½å»ºè®®</option>
                        <option value="general">ä¸€èˆ¬åé¦ˆ</option>
                    </select>
                </div>
                <div className="form-group">
                    <label htmlFor="feedbackMessage">è¯¦ç»†ä¿¡æ¯</label>
                    <textarea id="feedbackMessage" rows="8" required placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®..."></textarea>
                </div>
                 <div className="form-group">
                    <label htmlFor="feedbackEmail">æ‚¨çš„é‚®ç®± (å¯é€‰)</label>
                    <input type="email" id="feedbackEmail" placeholder="ä»¥ä¾¿æˆ‘ä»¬å›å¤æ‚¨"/>
                </div>
                <button type="submit" className="modal-button primary">æäº¤åé¦ˆ</button>
            </form>
        </div>
      </Drawer>

    </div>
  );
}

export default SpaceListPage;
