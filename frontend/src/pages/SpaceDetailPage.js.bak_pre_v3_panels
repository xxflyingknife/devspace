import React, { useState, useEffect } from 'react';
import { useParams } from 'react-router-dom';
import Header from '../components/Header';
import FileTreeViewer from '../components/FileTreeViewer'; // For Dev Space
import ChatInterface from '../components/ChatInterface';
import Accordion from '../components/Accordion';
import Modal from '../components/Modal'; // For K8s Deploy settings
import Drawer from '../components/Drawer';
// import K8sWorkloadDisplay from '../components/K8sWorkloadDisplay'; // Removed previously, add back if fixed
import LoadingSpinner from '../components/LoadingSpinner';
import './SpaceDetailPage.css';

// Mock data/functions (replace with API calls)
const mockFetchSpaceDetails = async (spaceId) => {
    await new Promise(resolve => setTimeout(resolve, 200));
    // Determine type based on ID for mock, real app gets from backend
    let type = 'dev';
    let name = spaceId.split('-').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' ');
    if (spaceId.includes('ops')) {
        type = 'ops';
    } else if (spaceId.includes('dev')) {
        type = 'dev';
    }
    // Simulate dynamic name fetching
    if (spaceId === 'proj-prefab-modular') name = 'é¢„åˆ¶å’Œæ¨¡å—åŒ–å»ºç­‘å¸‚åœºæ¦‚è§ˆ';
    else if (spaceId === 'ops-cluster-monitor') name = 'ç”Ÿäº§ç¯å¢ƒé›†ç¾¤ç›‘æ§ Ops';
    else if (spaceId === 'sre-incident-response') name = 'SRE äº‹ä»¶å“åº”æ‰‹å†Œ Ops';


    return { id: spaceId, name: name || `ç©ºé—´ ${spaceId}`, type: type, description: `è¿™æ˜¯ ${type} ç±»å‹çš„ç©ºé—´ ${spaceId} çš„æè¿°ã€‚` };
};

// Ops Space Left Panel Mock Data
const mockFetchOpsWorkloads = async (spaceId) => {
    await new Promise(resolve => setTimeout(resolve, 400));
    return [
        {id: 'wl-pod-grp-1', name: 'Frontend Pods (prod)', type: 'pods', status: 'Healthy', count: 5},
        {id: 'wl-deploy-db', name: 'Database Deployment (main)', type: 'deployment', status: 'Scaling', count: 1},
        {id: 'wl-svc-api', name: 'API Gateway Service', type: 'service', status: 'Degraded', count: 3},
        {id: 'wl-cron-backup', name: 'Daily Backup CronJob', type: 'cronjob', status: 'Scheduled', count: 1},
    ];
};
// Ops Space Right Panel Mock Data
const mockFetchAIOpsSkills = () => [{id: 'skill1', name: 'å¼‚å¸¸æ£€æµ‹'}, {id: 'skill2', name: 'æ ¹å› åˆ†æ'}];
const mockFetchSREPlans = () => [{id: 'plan1', name: 'æ•°æ®åº“æ‰©å®¹é¢„æ¡ˆ'}, {id: 'plan2', name: 'ç´§æ€¥å›æ»šæµç¨‹'}];
const mockFetchPrompts = () => [{id: 'p1', name: 'K8s Pod é‡å¯æ’æŸ¥'}, {id: 'p2', name: 'ç½‘ç»œå»¶è¿Ÿåˆ†æ'}];


function SpaceDetailPage() {
  const { spaceId } = useParams();
  const [spaceDetails, setSpaceDetails] = useState(null);
  const [isLoading, setIsLoading] = useState(true);
  const [error, setError] = useState(null);

  // State for Dev Space Right Panel (K8s Deploy)
  const [showDeploySettingsModal, setShowDeploySettingsModal] = useState(false);
  const [k8sEnvUrl, setK8sEnvUrl] = useState('https://kubernetes.default.svc'); // Mock
  const [deployments, _setDeployments] = useState([ // Mock K8s deployments for dev space
    { id: 'dep1', name: 'my-app-backend', status: 'Running', replicas: '2/2', lastDeployed: '2h ago'},
    { id: 'dep2', name: 'my-app-frontend', status: 'Pending', replicas: '0/1', lastDeployed: '5m ago'},
  ]);


  // State for Ops Space panels
  const [opsWorkloads, setOpsWorkloads] = useState([]);
  const [aiOpsSkills, setAIOpsSkills] = useState([]);
  const [srePlans, setSREPlans] = useState([]);
  const [savedPrompts, setSavedPrompts] = useState([]);

  // Theme and Drawer states (can be moved to a global context later)
  const [theme, setTheme] = useState(() => localStorage.getItem('theme') || 'system');
  const [showHelpDrawer, setShowHelpDrawer] = useState(false);
  const [showFeedbackDrawer, setShowFeedbackDrawer] = useState(false);

  useEffect(() => {
    setIsLoading(true);
    setError(null);
    mockFetchSpaceDetails(spaceId)
      .then(data => {
        setSpaceDetails(data);
        if (data.type === 'ops') {
            mockFetchOpsWorkloads(spaceId).then(setOpsWorkloads);
            setAIOpsSkills(mockFetchAIOpsSkills());
            setSREPlans(mockFetchSREPlans());
            setSavedPrompts(mockFetchPrompts());
        }
        // For Dev space, FileTreeViewer and Deployments have their own data/logic
      })
      .catch(err => {
        console.error("Error fetching space details:", err);
        setError("æ— æ³•åŠ è½½ç©ºé—´è¯¦æƒ…");
      })
      .finally(() => setIsLoading(false));
  }, [spaceId]);

  useEffect(() => {
    document.documentElement.setAttribute('data-theme', theme);
    localStorage.setItem('theme', theme);
  }, [theme]);

  const handleToggleTheme = (selectedTheme) => {
    setTheme(selectedTheme);
  };

  const handleSaveDeploySettings = (e) => {
      e.preventDefault();
      alert(`K8s Deploy Environment URL saved: ${k8sEnvUrl}`);
      // TODO: Call backend to save this
      setShowDeploySettingsModal(false);
  };

  if (isLoading) return (
    <div className="space-detail-page"><Header /><div className="loading-fullpage">åŠ è½½ç©ºé—´è¯¦æƒ…...</div></div>
  );
  if (error) return (
    <div className="space-detail-page"><Header /><div className="error-fullpage">{error}</div></div>
  );
  if (!spaceDetails) return (
    <div className="space-detail-page"><Header /><div className="error-fullpage">æœªæ‰¾åˆ°ç©ºé—´ã€‚</div></div>
  );


  const renderDevLeftPanel = () => (
    <FileTreeViewer repoId={spaceId} />
  );

  const renderDevRightPanel = () => (
    <>
      <div className="panel-header">
        <span className="panel-title">Deployments</span>
        <button className="panel-header-button" onClick={() => setShowDeploySettingsModal(true)} title="Configure K8s Environment">[âš™ï¸]</button>
        <button className="panel-header-button primary" onClick={() => alert('Trigger new deployment!')} title="New Deployment">[ğŸš€ Deploy]</button>
      </div>
      <div className="deploy-list-container">
        {deployments.length > 0 ? (
            <ul className="deploy-list">
                {deployments.map(dep => (
                    <li key={dep.id} className="deploy-list-item">
                        <strong className="deploy-name">{dep.name}</strong>
                        <span className={`deploy-status ${dep.status.toLowerCase()}`}>{dep.status}</span>
                        <span className="deploy-replicas">{dep.replicas}</span>
                        <span className="deploy-time">{dep.lastDeployed}</span>
                        <button className="deploy-action-button">[â€¦]</button>
                    </li>
                ))}
            </ul>
        ) : <p>No deployments configured for this space yet.</p>}
      </div>
      {showDeploySettingsModal && (
        <Modal isOpen={showDeploySettingsModal} onClose={() => setShowDeploySettingsModal(false)} title="Configure K8s Deploy Environment">
          <form onSubmit={handleSaveDeploySettings} className="modal-form">
            <div className="form-group">
              <label htmlFor="k8sEnvUrl">K8s Environment URL/Context:</label>
              <input type="text" id="k8sEnvUrl" value={k8sEnvUrl} onChange={(e) => setK8sEnvUrl(e.target.value)} required />
            </div>
            <div className="modal-form-actions">
              <button type="button" className="modal-button secondary" onClick={() => setShowDeploySettingsModal(false)}>å–æ¶ˆ</button>
              <button type="submit" className="modal-button primary">ä¿å­˜</button>
            </div>
          </form>
        </Modal>
      )}
    </>
  );

  const renderOpsLeftPanel = () => (
    <>
        <div className="panel-header">
            <span className="panel-title">Workloads</span>
            {/* Add controls like filter/sort if needed */}
        </div>
        <div className="ops-workload-list-container">
            {opsWorkloads.length > 0 ? (
                <ul className="ops-workload-list">
                    {opsWorkloads.map(wl => (
                        <li key={wl.id} className="ops-workload-item">
                            <span className="workload-icon">{wl.type === 'pods' ? 'â–¡' : (wl.type === 'deployment' ? 'D' : 'S')}</span>
                            <span className="workload-name">{wl.name}</span>
                            <span className={`workload-status ${wl.status.toLowerCase().replace(' ', '-')}`}>{wl.status}</span>
                            <span className="workload-count">{wl.count}</span>
                        </li>
                    ))}
                </ul>
            ) : <p>No workloads to display for this space.</p>}
        </div>
    </>
  );

 const renderOpsRightPanel = () => (
    <>
        <div className="panel-header">
            <span className="panel-title">AIOps Studio</span>
             {/* Controls could go here */}
        </div>
        <div className="ops-right-panel-content">
            <Accordion title="AIOps æŠ€èƒ½æ’ä»¶" initialOpen={true}>
                <ul className="ops-plugin-list">
                    {aiOpsSkills.map(skill => <li key={skill.id}><button>{skill.name}</button></li>)}
                </ul>
            </Accordion>
            <Accordion title="SRE è®¡åˆ’ä»»åŠ¡" initialOpen={false}>
                <ul className="ops-plugin-list">
                    {srePlans.map(plan => <li key={plan.id}><button>{plan.name}</button></li>)}
                </ul>
                 <button className="add-new-button">+ æ–°å»ºè®¡åˆ’</button>
            </Accordion>
            <Accordion title="Prompt è®°äº‹æœ¬" initialOpen={false}>
                <ul className="ops-plugin-list">
                    {savedPrompts.map(p => <li key={p.id}><button>{p.name}</button></li>)}
                </ul>
                 <button className="add-new-button">+ ä¿å­˜å½“å‰ä¼šè¯</button>
            </Accordion>
        </div>
    </>
 );


  return (
    <div className="space-detail-page">
      <Header
        pageType="detail"
        spaceType={spaceDetails.type}
        spaceName={spaceDetails.name}
        onToggleTheme={handleToggleTheme}
        onShowHelp={() => setShowHelpDrawer(true)}
        onShowFeedback={() => setShowFeedbackDrawer(true)}
      />

      <main className="three-column-layout">
        <div className="column left-column">
          {spaceDetails.type === 'dev' ? renderDevLeftPanel() : renderOpsLeftPanel()}
        </div>

        <div className="column middle-column">
          <ChatInterface spaceId={spaceId} />
        </div>

        <div className="column right-column">
          {spaceDetails.type === 'dev' ? renderDevRightPanel() : renderOpsRightPanel()}
        </div>
      </main>

      {/* Drawers (same as SpaceListPage) */}
      <Drawer isOpen={showHelpDrawer} onClose={() => setShowHelpDrawer(false)} title="å¸®åŠ©ä¸­å¿ƒ" position="right">
        <div className="drawer-content-placeholder">
            <h2>å¦‚ä½•ä½¿ç”¨ç©ºé—´è¯¦æƒ…</h2>
            {spaceDetails.type === 'dev' && (
                <>
                    <p><strong>Dev ç©ºé—´:</strong></p>
                    <p>å·¦ä¾§æ æ˜¯æ‚¨çš„ Git ä»“åº“æ–‡ä»¶æµè§ˆå™¨ã€‚æ‚¨å¯ä»¥åœ¨æ­¤æŸ¥çœ‹æ–‡ä»¶ã€åˆ‡æ¢åˆ†æ”¯ï¼Œå¹¶é€šè¿‡é¡¶éƒ¨çš„è®¾ç½®æŒ‰é’®é…ç½®ä»“åº“åœ°å€ã€‚</p>
                    <p>ä¸­é—´æ˜¯ä¸ AI åŠ©æ‰‹çš„èŠå¤©çª—å£ï¼Œæ‚¨å¯ä»¥è®©å®ƒå¸®åŠ©æ‚¨ç†è§£ä»£ç ã€ç”Ÿæˆæäº¤ä¿¡æ¯ã€æ‰§è¡Œ Git æ“ä½œï¼ˆé€šè¿‡å·¥å…·ï¼‰ç­‰ã€‚</p>
                    <p>å³ä¾§æ æ˜¾ç¤ºæ‚¨çš„ Kubernetes éƒ¨ç½²ç¯å¢ƒã€‚æ‚¨å¯ä»¥æŸ¥çœ‹éƒ¨ç½²çŠ¶æ€ï¼Œå¹¶é€šè¿‡é¡¶éƒ¨çš„â€œéƒ¨ç½²â€æŒ‰é’®è§¦å‘æ–°çš„éƒ¨ç½²æµç¨‹æˆ–é…ç½®ç¯å¢ƒåœ°å€ã€‚</p>
                </>
            )}
            {spaceDetails.type === 'ops' && (
                 <>
                    <p><strong>Ops ç©ºé—´:</strong></p>
                    <p>å·¦ä¾§æ æ˜¾ç¤ºäº†æ‚¨å½“å‰å…³æ³¨çš„ Kubernetes Workloads åˆ—è¡¨åŠå…¶çŠ¶æ€ã€‚</p>
                    <p>ä¸­é—´æ˜¯ä¸ AI åŠ©æ‰‹çš„èŠå¤©çª—å£ï¼Œæ‚¨å¯ä»¥è®©å®ƒå¸®åŠ©æ‚¨æŸ¥è¯¢ç›‘æ§æ•°æ®ã€åˆ†ææ—¥å¿—ã€æ‰§è¡Œé¢„å®šä¹‰çš„è¿ç»´æ“ä½œï¼ˆé€šè¿‡å·¥å…·ï¼‰ç­‰ã€‚</p>
                    <p>å³ä¾§æ æ˜¯ AIOps Studioï¼ŒåŒ…å«å¯ç”¨çš„ AIOps æŠ€èƒ½æ’ä»¶ã€SRE è‡ªåŠ¨åŒ–è®¡åˆ’ä»»åŠ¡å’Œæ‚¨ä¿å­˜çš„ Prompt ä¼šè¯ï¼Œæ–¹ä¾¿å¿«é€Ÿè°ƒç”¨å’Œå¤ç”¨ã€‚</p>
                </>
            )}
            <p>é€šç”¨æç¤ºï¼šä½¿ç”¨èŠå¤©çª—å£åº•éƒ¨çš„å·¥å…·æŒ‰é’®ï¼ˆå¦‚æœå¯ç”¨ï¼‰æ¥æ‰§è¡Œç‰¹å®šåœºæ™¯çš„è‡ªåŠ¨åŒ–æ“ä½œã€‚</p>
        </div>
      </Drawer>
      <Drawer isOpen={showFeedbackDrawer} onClose={() => setShowFeedbackDrawer(false)} title="æäº¤åé¦ˆ" position="right">
        <div className="drawer-content-placeholder">
            <h2>æˆ‘ä»¬é‡è§†æ‚¨çš„æ„è§ï¼</h2>
            <form className="feedback-form" onSubmit={(e) => {e.preventDefault(); alert('æ„Ÿè°¢æ‚¨çš„åé¦ˆï¼'); setShowFeedbackDrawer(false);}}>
                {/* Feedback form content (same as list page) */}
                <div className="form-group">
                    <label htmlFor="feedbackType">åé¦ˆç±»å‹</label>
                    <select id="feedbackType"><option value="bug">é”™è¯¯æŠ¥å‘Š</option><option value="feature">åŠŸèƒ½å»ºè®®</option></select>
                </div>
                <div className="form-group">
                    <label htmlFor="feedbackMessage">è¯¦ç»†ä¿¡æ¯</label>
                    <textarea id="feedbackMessage" rows="8" required placeholder="è¯·è¯¦ç»†æè¿°æ‚¨çš„é—®é¢˜æˆ–å»ºè®®..."></textarea>
                </div>
                <button type="submit" className="modal-button primary">æäº¤åé¦ˆ</button>
            </form>
        </div>
      </Drawer>

    </div>
  );
}

export default SpaceDetailPage;
